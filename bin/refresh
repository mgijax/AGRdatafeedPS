#!/bin/bash

# ---------------------
if [ ! -r ../Configuration ] ; then
    echo "Cannot read Configuration file."
    exit 1
fi
source ../Configuration

# ---------------------
# Initialize vars
LOGFILE=""
OUTPUT_DIR="."
RELEASE_COUNT=""
DO_ALL="true"
VALIDATOR_DIR="../agr_curation_schema"
DO_GENERATE=""
DO_VALIDATE=""
DO_UPLOAD=""
TOKEN_FILE=""
NO_RUN=""

# ---------------------
function usage {
  logit "
Usage: $0 [-d output_directory][-p d][-g][-v dir][-u file]

Installation settings:
    AGR_CURATION_SCHEMA_VERSION=${AGR_CURATION_SCHEMA_VERSION}
	
Options:
-h	Print this message and exit.
-C file	Sources the specified config file.
-l file Specifies a log file. By default, log messages are sent to stdout.

-c n	Specifies the update count for this schema version (1, 2, 3, ...).  Optional.
-d dir	Specifies the parent directory where the output directory will be created.
	Default = current working directory.
-p pts	Specify which part(s) to run. Argument is a comma-separated list (no spaces) of any of the following:
	d	Disease annotations
        g       Genes (and other features)
        a       Alleles
        y       Genotypes (AGRs)

	If no -p option is provided, all parts are run.

You need to specify at least one of the following options to actually do anything:
-g      Generate data files specified in -p option.
-v 	Validate data files specified in -p option. 
-u file Upload files specified in -p option to the Alliance submission endpoint. 
	Argument is the file containing the DQM access token.

Debugging:
-N	No execute. Skips actually running commands; just prints what it would do.
"
}

# ---------------------------------------
function setFile {
  ftype="$1"
  if [[ ${ftype} == "GFF" ]] ; then
      FILE="${ROOT}_${ftype}.gff3"
  elif [[ ${ftype} == "assembly" ]] ; then
      FILE="${ROOT}_${ftype}.fa.gz"
  else
      FILE="${ROOT}_${ftype}.json"
  fi
}

# ---------------------------------------
function generate {
  ftype="$1"
  script="$2"
  setFile ${ftype}
  logit "Generating ${ftype} file: ${FILE} with command: ${script}"
  if [[ ${NO_RUN} ]] ; then
    return
  fi
  if [[ ${ftype} == "GFF" ]] ; then
      if [[ ${DO_GENERATE} ]] ; then
	  url=${script}
	  curl ${url} | gunzip > ${FILE}
      fi
  elif [[ ${ftype} == "assembly" ]] ; then
      return
  else
      if [[ ${DO_GENERATE} ]] ; then
	  ${PYTHON} ${script} > ${FILE}
	  checkexit
      fi
  fi
}

# ---------------------
# Run the agr validator. 
# Args:
#  $1 = path (from the schema directory) to the curation schema file
#  $2 = full path to the file
function validate {
  ftype=$1
  setFile ${ftype}
  logit "Validating ${FILE} ..."
  if [[ ${NO_RUN} ]] ; then
    return
  fi
  #
  # ASSUMES the validator is checked out to the correct schema version!
  #
  source ./venv/bin/activate
  python validateJsonFile.py -d ${FILE} -s ${VALIDATOR_DIR}/generated/jsonschema/allianceModel.schema.json
  checkexit 
  logit "Validated: ${FILE}"
  deactivate
}
# ---------------------
# See: https://github.com/alliance-genome/agr_curation#submitting-data
# See: https://${curation_system}.alliancegenome.org/api/version
function upload {
  ftype=$1
  aftype=$2
  curation_system="curation" # also: alpha-curation, beta-curation
  url="https://${curation_system}.alliancegenome.org/api/data/submit"
  token=`cat ${TOKEN_FILE}`
  setFile ${ftype}
  command="curl \
    -H \"Authorization: Bearer ${token}\" \
    -X POST \"${url}\" \
    -F \"${aftype}_MGI=@${FILE}\""
  logit "Uploading file with command: ${command}"
  if [[ ${NO_RUN} ]] ; then
    return
  fi
  curl \
      -H "Authorization: Bearer ${token}" \
      -X POST "${url}" \
      -F "${aftype}_MGI=@${FILE}"
  checkexit
  logit "Uploaded: ${FILE}"
}

# ---------------------------------------
function doPart {
  part="$1"
  script="$2"
  ftype="$3"
  allianceftype="$4"
  if [[ ${DO_ALL} || " ${PARTS[*]} " == *" ${part} "* ]]; then
      if [[ ${DO_GENERATE} ]] ; then
	  generate "${ftype}" "${script}"
      fi
      if [[ ${DO_VALIDATE} ]] ; then
	  validate "${ftype}"
      fi
      if [[ ${DO_UPLOAD} ]] ; then
	  upload "${ftype}" "${allianceftype}"
      fi
  else
      logit "Skipping ${ftype}."
  fi
}

# ---------------------------------------
function parseCommandLine {
    # Process command line args
    until [ -z "$1" ] 
    do
	case "$1" in
	-h)
	    usage
	    exit 0
	    ;;
	-l)
	    shift
	    LOGFILE="$1"
	    ;;
	-g)
	    DO_GENERATE="true"
	    ;;
	-v) 
	    DO_VALIDATE="true"
	    ;;  
	-u) 
	    shift
	    TOKEN_FILE="$1"
	    DO_UPLOAD="true"
	    ;;  
	-p)
	    shift
	    PARTS=(${1//,/ })
	    DO_ALL=""
	    ;;
	-d) 
	    shift
	    OUTPUT_DIR="$1"
	    ;;  
	-R) 
	    shift
	    AGR_CURATION_SCHEMA_VERSION="$1"
	    ;;  
	-c) 
	    shift
	    RELEASE_COUNT="$1"
	    ;;  
	-N)
	    NO_RUN="true"
	    ;;
	*)  
	    usage
	    die "Unrecognized option:" $1
	esac
	shift
    done
    # ---------------------------------------
    # Check parameters
    if [[ ! ${AGR_CURATION_SCHEMA_VERSION} ]] ; then
      die "Please specify a release version with -R."
    fi
}


function doParts {
    # args: cmdAbbrev; fileType; script; schemaFile; grepPattern; allianceFileType
    doPart "g" "genes.py"   "gene"   "GENE"
    doPart "a" "alleles.py" "allele" "ALLELE"
    doPart "y" "agms.py"    "agm"    "AGM"
    doPart "d" "diseaseAnnotations.py" "disease_annotation" "DISEASE_ANNOTATION"
}

function main {
    #
    parseCommandLine $*
    #
    ODIR=`realpath "${OUTPUT_DIR}/${AGR_CURATION_SCHEMA_VERSION}"`
    if [[ ${RELEASE_COUNT} ]] ; then
	ODIR="${ODIR}_${RELEASE_COUNT}"
    fi
    ROOT="${ODIR}/MGI_ps"

    # ---------------------------------------
    logit
    logit "This is the Alliance Persistent Store datafeed pipeline. Starting run..."
    logit "Reading from ${PG_DBSERVER}.${PG_DBNAME}"

    # ---------------------------------------
    #
    logit "mkdir -p ${ODIR}"
    mkdir -p ${ODIR}
    checkexit

    if [[ ${LOGFILE} ]]; then
        doParts >>${LOGFILE} 2>&1
    else
        doParts
    fi

    logit "Finished."
}

main $*
